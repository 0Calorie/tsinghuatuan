{% extends "mobile_base.html" %}

{% load staticfiles %}

{% block title %}
绑定学号 - 清华紫荆之声
{% endblock %}

{% block css %}
<link href="{% static "css/validation.css" %}?_=3" rel="stylesheet" type="text/css" />
{% endblock %}

{% block js %}
    <script >
    /**
 * Created with PyCharm.
 * User: Epsirom
 * Date: 13-11-29
 * Time: 下午5:27
 */

var xmlhttp = null;

function hideElem(id) {
    document.getElementById(id).setAttribute('style', 'display:none');
}

function showElem(id) {
    document.getElementById(id).setAttribute('style', 'display:block');
}

function clearHelp(groupid, helpid) {
    document.getElementById(groupid).setAttribute('class', 'form-group');
    //document.getElementById(helpid).setAttribute('hidden', 'hidden');
    //document.getElementById(helpid).setAttribute('style', 'display:none;');
    hideElem(helpid);
}

function clearAllHelps() {
    clearHelp('usernameGroup', 'helpUsername');
    clearHelp('passwordGroup', 'helpPassword');
    clearHelp('submitGroup', 'helpSubmit');
}

function showSuccess(groupid, helpid) {
    document.getElementById(groupid).setAttribute('class', 'form-group has-success');
    //document.getElementById(helpid).setAttribute('hidden', 'hidden');
    hideElem(helpid);
}

function showError(groupid, helpid, text) {
    var dom = document.getElementById(helpid);
    dom.innerText = text;
    //dom.removeAttribute('hidden');
    showElem(helpid);
    document.getElementById(groupid).setAttribute('class', 'form-group has-error');
}

function disableOne(id, flag) {
    var dom = document.getElementById(id);
    if (flag) {
        dom.setAttribute('disabled', 'disabled');
    } else {
        dom.removeAttribute('disabled');
    }
}

function disableAll(flag) {
    disableOne('inputUsername', flag);
    disableOne('inputPassword', flag);
    disableOne('submitBtn', flag);
}

function showLoading(flag) {
    //var dom = document.getElementById('helpLoading');
    if (flag) {
        //dom.removeAttribute('hidden');
        showElem('helpLoading');
    } else {
        //dom.setAttribute('hidden', 'hidden');
        hideElem('helpLoading');
    }
}

function readyStateChanged() {
    if (xmlhttp.readyState==4)
    {// 4 = "loaded"
        if (xmlhttp.status==200)
        {// 200 = OK
            var dom = document.getElementById("asd");
        dom.innerText = 'xmlhttp in.';
        //dom.removeAttribute('hidden');
            showError('submitGroup', 'helpSubmit', JSON.stringify(xmlhttp.responseText, null, 4));
            /*var result = xmlhttp.responseText;
            switch (result)
            {
                case 'Accepted':
                    //document.getElementById('validationHolder').setAttribute('hidden', 'hidden');
                    hideElem('validationHolder');
                    //document.getElementById('successHolder').removeAttribute('hidden');
                    showElem('successHolder');
                    return;

                case 'Rejected':
                    showError('usernameGroup', 'helpUsername', '');
                    showError('passwordGroup', 'helpPassword', '学号或密码错误！请输入登录info的学号和密码');
                    break;

                case 'Error':
                    showError('submitGroup', 'helpSubmit', '出现了奇怪的错误，我们已经记录下来了，请稍后重试。')
                    break;
            }*/
        }
        else
        {
            showError('submitGroup', 'helpSubmit', '服务器连接异，请稍后重试。')
        }
        showLoading(false);
        disableAll(false);
    }
}

function submitValidation(openid) {
    var dom = document.getElementById("asd");
        dom.innerText = 'submitValidation in.';
        //dom.removeAttribute('hidden');
    if (checkUsername() & checkPassword()) {
        dom.innerText = 'check complete.';
        //dom.removeAttribute('hidden');
        disableAll(true);
        showLoading(true);
        /*var form = document.getElementById('validationForm'),
            elems = form.elements,
            url = form.action,
            params = "openid=" + encodeURIComponent(openid),
            i, len;
        for (i = 0, len = elems.length; i < len; ++i) {
            params += '&' + elems[i].name + '=' + encodeURIComponent(elems[i].value);
        }
        xmlhttp = new XMLHttpRequest();
        xmlhttp.open('POST', url, true);
        xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xmlhttp.onreadystatechange = readyStateChanged;
        xmlhttp.send(params);*/
        /*var key = new RSAKeyPair("10001", "", "89323ab0fba8422ba79b2ef4fb4948ee5158f927f63daebd35c7669fc1af6501ceed5fd13ac1d236d144d39808eb8da53aa0af26b17befd1abd6cfb1dcfba937438e4e95cd061e2ba372d422edbb72979f4ccd32f75503ad70769e299a4143a428380a2bd43c30b0c37fda51d6ee7adbfec1a9d0ad1891e1ae292d8fb992821b");
        dom.innerText = 'key done.';
        //dom.removeAttribute('hidden');
        timeGeter = new XMLHttpRequest();
        timeGeter.onreadystatechange = function (){
            if(timeGeter.readyState==4){
                if(timeGeter.status==200){
        dom.innerText = 'timeGeter in.';
        //dom.removeAttribute('hidden');
                    var se = "secret=" + encryptedString(key, timeGeter.responseText + "|" + $("#inputUsername").val() + "|" + $("#inputPassword").val());
                    xmlhttp = new XMLHttpRequest();
                    xmlhttp.open('POST', "http://auth.igeek.asia/v1", true)
                    xmlhttp.onreadystatechange = readyStateChanged;
                    xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xmlhttp.send(se)
        dom.innerText = 'xmlhttp out.';
        //dom.removeAttribute('hidden');
                }
                else{
                    showError('submitGroup', 'helpSubmit', timeGeter.status + timeGeter.statusText + timeGeter.responseText);
                }
            }
            showLoading(false);
            disableAll(false);
        }
        timeGeter.open('GET', "http://auth.igeek.asia/v1/time", true);
        //dom.removeAttribute('hidden');
        timeGeter.send();*/
        var key = new RSAKeyPair("10001", "", "89323ab0fba8422ba79b2ef4fb4948ee5158f927f63daebd35c7669fc1af6501ceed5fd13ac1d236d144d39808eb8da53aa0af26b17befd1abd6cfb1dcfba937438e4e95cd061e2ba372d422edbb72979f4ccd32f75503ad70769e299a4143a428380a2bd43c30b0c37fda51d6ee7adbfec1a9d0ad1891e1ae292d8fb992821b");
        $("#testForm").on('submit', function(e) {
            e.preventDefault();
            showError('submitGroup', 'helpSubmit', "正在认证，请稍候……");
            $.ajax({
                url: "http://auth.igeek.asia/v1/time",
                type: "GET",
                success: function(time) {
                    $.ajax({
                        url: "http://auth.igeek.asia/v1",
                        type: "POST",
                        data: {
                            secret: encryptedString(key, time + "|" + $("#inputUsername").val() + "|" + $("#inputPassword").val())
                        },
                        dataType: "json",
                        success: function(data) {
                            showError('submitGroup', 'helpSubmit', JSON.stringify(data, null, 4));
                        },
                        error: function() {
                            showError('submitGroup', 'helpSubmit', "认证服务出错，请重试……");
                        }
                    })
                },
                error: function() {
                    showError('submitGroup', 'helpSubmit', "获取时间失败，请重试……");
                }
            });
        }
    }
    return false;
}

function checkNotEmpty(groupid, helpid, inputid, hintName) {
    if (document.getElementById(inputid).value.trim().length == 0) {
        document.getElementById(groupid).setAttribute('class', 'form-group has-error');
        var dom = document.getElementById(helpid);
        dom.innerText = '请输入' + hintName + '！';
        //dom.removeAttribute('hidden');
        showElem(helpid);
        return false;
    } else {
        showSuccess(groupid, helpid);
        return true;
    }
}

function checkIsDigit(groupid, helpid, inputid, hintName) {
    if (isNaN(document.getElementById(inputid).value)) {
        document.getElementById(groupid).setAttribute('class', 'form-group has-error');
        var dom = document.getElementById(helpid);
        dom.innerText = hintName + '必须为数字！';
        //dom.removeAttribute('hidden');
        showElem(helpid);
        return false;
    } else {
        showSuccess(groupid, helpid);
        return true;
    }
}

function checkUsername() {
    if (checkNotEmpty('usernameGroup', 'helpUsername', 'inputUsername', '学号')) {
        return checkIsDigit('usernameGroup', 'helpUsername', 'inputUsername', '学号');
    }
    return false;
}

function checkPassword() {
    return checkNotEmpty('passwordGroup', 'helpPassword', 'inputPassword', '密码');
}

window.setupWeixin({'optionMenu':false, 'toolbar':false});

clearAllHelps();

/*
document.getElementById('inputUsername').onfocus = function(){
    setfooter();
}

document.getElementById('inputPassword').onfocus = function(){
    setfooter();
}*/

function showValidation(isValidated) {
    if (!isValidated) {
        document.getElementById('inputUsername').focus();
    } else {
        showElem('successHolder');
        hideElem('validationHolder');
    }
}
</script>
    <script src="{% static "lib/jquery/jquery-1.11.1.min.js" %}"></script>
    <script src="{% static "lib/RSA/fullRSA.js" %}"></script>
    <script>
    function ajaxForm() {
    var dom = document.getElementById("asd");
    dom.innerText = 'At least I try...';
        submitValidation('{{ openid }}');
            dom.innerText = 'At least I Quit';
    }
    window.addEventListener('load', function() {showValidation({{ isValidated }});}, false);
    </script>
{% endblock %}

{% block theme %}
    用户认证2
{% endblock %}

{% block content %}
    <div id="validationHolder">
        <form class="form-horizontal" role="form" action="{% url "userpage.views.validate_post" %}" method="post" id="validationForm" onsubmit="return false;">
            {% csrf_token %}
          <div class="form-group" id="usernameGroup">
            <label for="inputUsername" class="col-xs-3 control-label">学号</label>
            <div class="col-xs-9">
                <p id = "asd">What do You Want?</p>
              <input type="tel" class="form-control" id="inputUsername" placeholder="请输入您的学号" name="username" value="{{ studentid }}" onblur="checkUsername();">
              <span class="help-block" id="helpUsername"></span>
            </div>
          </div>
          <div class="form-group" id="passwordGroup">
            <label for="inputPassword" class="col-xs-3 control-label">密码</label>
            <div class="col-xs-9">
              <input type="password" class="form-control" id="inputPassword" placeholder="使用info密码进行登录" name="password" onblur="checkPassword();">
              <span class="help-block" id="helpPassword"></span>
            </div>
          </div>
          <div class="form-group" id="submitGroup">
            <div class="col-xs-offset-3 col-xs-9">
              <button onclick="ajaxForm();" class="btn btn-default" id="submitBtn">认证</button>
              <p class="help-block" id="helpLoading" style="display: none"><img src="{% static "img/loading.gif" %}">正在认证，请稍候...</p>
              <p class="help-block" id="helpSubmit"></p>
            </div>
          </div>
        </form>
    </div>
    <div id="successHolder" style="display: none">
        <img src="{% static "img/success.png" %}" />
        <p>认证成功！</p>
        <p>您已经可以使用“紫荆之声”的全部功能了！</p>
    </div>
{% endblock %}
